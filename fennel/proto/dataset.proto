syntax = "proto3";

package fennel.proto;

import "status.proto";

// All integers representing time are in microseconds.
message DatasetField {
  string name = 1;
  // TODO: Create Type protos
  // Type type = 2;
  bool is_key = 4;
  bool is_timestamp = 5;
  string owner = 6;
  string description = 7;
  bool is_nullable = 8;
  repeated string tags = 9;
}

message ApiLookup {
  string name = 1;
  int32 ttl = 2;
  int32 priority = 3;
  string function_source_code = 4;
  bytes function = 5;
}

message CreateDatasetRequest {
  string name = 1;
  repeated DatasetField fields = 2;
  int32 retention_period = 3;
  // Default mode is pandas.
  string mode = 4;
  string description = 5;
  uint32 version = 6;

  // Fields 7 - 10 are for derived datasets.
  bool is_derived = 7;
  string base_dataset = 8;
  string value_field = 9;

  repeated ApiLookup api_lookups = 10;
}

message CreateDatasetResponse{
  string dataset_name = 1;
  Status status = 2;
}

// ----------------------------------------------------------------------------
// Aggregate Definitions
// ----------------------------------------------------------------------------

enum AggregateFunction {
  SUM = 0;
  AVG = 1;
  COUNT = 2;
  MIN = 3;
  MAX = 4;
  RATE = 5;
  KEY_VALUE = 6;
  TOPK = 7;
  CF = 8;
}

message Window {
  int32 from = 1;
  int32 to = 2;
}

message DeltaWindow {
  Window baseline = 1;
  Window target = 2;
}

message WindowSpec {
  oneof WindowType {
    bool forever_window = 1;
    Window window = 2;
    DeltaWindow delta_window = 3;
  }
}

message AggregateType {
  AggregateFunction function = 1;
  repeated string key_fields = 2;
  string timestamp_field = 3;
  repeated WindowSpec windows = 4;

  oneof Config {
    string value_field = 5;
    TopKConfig topk_config = 6;
    CFConfig cf_config = 7;
  }
}

message TopKConfig {
  int32 k = 1;
  repeated string item_fields = 2;
  string score_field = 3;
}

message CFConfig {
  int32 limit = 1;
  repeated string context_fields = 2;
  string weight_field = 3;
}